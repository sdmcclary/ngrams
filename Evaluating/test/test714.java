public class FTPAdvancedOptionsComposite extends Composite implements IOptionsComposite { private static final String EMPTY = "" ; private IConnectionDialog connectionDialog ; private Combo modeCombo ; private Text portText ; private Combo encodingCombo ; private Combo timezoneCombo ; private Button detectButton ; private ModifyListener modifyListener ; public FTPAdvancedOptionsComposite ( Composite parent , int style , IConnectionDialog connectionDialog ) { super ( parent , style ) ; this . connectionDialog = connectionDialog ; setLayout ( GridLayoutFactory . swtDefaults ( ) . numColumns ( 5 ) . spacing ( new PixelConverter ( this ) . convertHorizontalDLUsToPixels ( IDialogConstants . HORIZONTAL_SPACING ) , new PixelConverter ( this ) . convertVerticalDLUsToPixels ( IDialogConstants . VERTICAL_SPACING ) ) . create ( ) ) ; Label label = new Label ( this , SWT . NONE ) ; label . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( new PixelConverter ( this ) . convertHorizontalDLUsToPixels ( IDialogConstants . LABEL_WIDTH ) , SWT . DEFAULT ) . create ( ) ) ; label . setText ( StringUtils . makeFormLabel ( "Connect Mode" ) ) ; modeCombo = new Combo ( this , SWT . DROP_DOWN | SWT . READ_ONLY | SWT . BORDER ) ; modeCombo . add ( "Active" ) ; modeCombo . add ( "Passive" ) ; modeCombo . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( modeCombo . computeSize ( SWT . DEFAULT , SWT . DEFAULT , true ) . x , SWT . DEFAULT ) . create ( ) ) ; label = new Label ( this , SWT . NONE ) ; label . setLayoutData ( GridDataFactory . swtDefaults ( ) . align ( SWT . END , SWT . CENTER ) . hint ( new PixelConverter ( this ) . convertHorizontalDLUsToPixels ( IDialogConstants . LABEL_WIDTH ) , SWT . DEFAULT ) . create ( ) ) ; label = new Label ( this , SWT . NONE ) ; label . setLayoutData ( GridDataFactory . swtDefaults ( ) . create ( ) ) ; label . setText ( StringUtils . makeFormLabel ( "Port" ) ) ; portText = new Text ( this , SWT . SINGLE | SWT . RIGHT | SWT . BORDER ) ; portText . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( Math . max ( new PixelConverter ( portText ) . convertWidthInCharsToPixels ( 5 ) , portText . computeSize ( SWT . DEFAULT , SWT . DEFAULT , true ) . x ) , SWT . DEFAULT ) . create ( ) ) ; label = new Label ( this , SWT . NONE ) ; label . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( new PixelConverter ( this ) . convertHorizontalDLUsToPixels ( IDialogConstants . LABEL_WIDTH ) , SWT . DEFAULT ) . create ( ) ) ; label . setText ( StringUtils . makeFormLabel ( "Encoding" ) ) ; encodingCombo = new Combo ( this , SWT . DROP_DOWN | SWT . READ_ONLY | SWT . BORDER ) ; encodingCombo . setItems ( Charset . availableCharsets ( ) . keySet ( ) . toArray ( new String [ 0 ] ) ) ; encodingCombo . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( encodingCombo . computeSize ( SWT . DEFAULT , SWT . DEFAULT , true ) . x , SWT . DEFAULT ) . span ( 4 , 1 ) . create ( ) ) ; Composite container = new Composite ( this , SWT . NONE ) ; container . setLayoutData ( GridDataFactory . fillDefaults ( ) . grab ( true , false ) . span ( 5 , 1 ) . create ( ) ) ; container . setLayout ( GridLayoutFactory . fillDefaults ( ) . numColumns ( 3 ) . create ( ) ) ; label = new Label ( container , SWT . NONE ) ; label . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( new PixelConverter ( this ) . convertHorizontalDLUsToPixels ( IDialogConstants . LABEL_WIDTH ) , SWT . DEFAULT ) . create ( ) ) ; label . setText ( StringUtils . makeFormLabel ( "Timezone" ) ) ; timezoneCombo = new Combo ( container , SWT . DROP_DOWN | SWT . READ_ONLY | SWT . BORDER ) ; String [ ] timezones = TimeZone . getAvailableIDs ( ) ; Arrays . sort ( timezones ) ; timezoneCombo . setItems ( timezones ) ; timezoneCombo . add ( EMPTY , 0 ) ; timezoneCombo . setLayoutData ( GridDataFactory . swtDefaults ( ) . hint ( timezoneCombo . computeSize ( SWT . DEFAULT , SWT . DEFAULT , true ) . x , SWT . DEFAULT ) . create ( ) ) ; detectButton = new Button ( container , SWT . PUSH ) ; detectButton . setText ( "Detect" ) ; detectButton . setLayoutData ( GridDataFactory . fillDefaults ( ) . hint ( Math . max ( new PixelConverter ( detectButton ) . convertHorizontalDLUsToPixels ( IDialogConstants . BUTTON_WIDTH ) , detectButton . computeSize ( SWT . DEFAULT , SWT . DEFAULT , true ) . x ) , SWT . DEFAULT ) . create ( ) ) ; addListeners ( ) ; portText . addVerifyListener ( new NumberVerifyListener ( ) ) ; detectButton . addSelectionListener ( new SelectionAdapter ( ) { @ Override public void widgetSelected ( SelectionEvent e ) { detectTimezone ( ) ; } } ) ; } public void loadPropertiesFrom ( Object element ) { Assert . isLegal ( element instanceof IBaseFTPConnectionPoint ) ; IBaseFTPConnectionPoint ftpConnectionPoint = ( IBaseFTPConnectionPoint ) element ; removeListeners ( ) ; try { modeCombo . select ( ftpConnectionPoint . isPassiveMode ( ) ? 1 : 0 ) ; portText . setText ( Integer . toString ( ftpConnectionPoint . getPort ( ) ) ) ; int index = encodingCombo . indexOf ( String . valueOf ( ftpConnectionPoint . getEncoding ( ) ) ) ; if ( index >= 0 ) { encodingCombo . select ( index ) ; } index = timezoneCombo . indexOf ( String . valueOf ( ftpConnectionPoint . getTimezone ( ) ) ) ; if ( index >= 0 ) { timezoneCombo . select ( index ) ; } else { timezoneCombo . select ( timezoneCombo . indexOf ( EMPTY ) ) ; } } finally { addListeners ( ) ; } } public boolean savePropertiesTo ( Object element ) { Assert . isLegal ( element instanceof IBaseFTPConnectionPoint ) ; boolean updated = false ; IBaseFTPConnectionPoint ftpConnectionPoint = ( IBaseFTPConnectionPoint ) element ; boolean passiveMode = modeCombo . getSelectionIndex ( ) == 1 ; if ( ftpConnectionPoint . isPassiveMode ( ) != passiveMode ) { ftpConnectionPoint . setPassiveMode ( passiveMode ) ; updated = true ; } int port = Integer . parseInt ( portText . getText ( ) ) ; if ( ftpConnectionPoint . getPort ( ) != port ) { ftpConnectionPoint . setPort ( port ) ; updated = true ; } String encoding = encodingCombo . getItem ( encodingCombo . getSelectionIndex ( ) ) ; if ( ! ftpConnectionPoint . getEncoding ( ) . equals ( encoding ) ) { ftpConnectionPoint . setEncoding ( encoding ) ; updated = true ; } String timezone = timezoneCombo . getItem ( timezoneCombo . getSelectionIndex ( ) ) ; if ( EMPTY . equals ( timezone ) ) { timezone = null ; } if ( ftpConnectionPoint . getTimezone ( ) != timezone && ( timezone == null || ! timezone . equals ( ftpConnectionPoint . getTimezone ( ) ) ) ) { ftpConnectionPoint . setTimezone ( timezone ) ; updated = true ; } return updated ; } public String isValid ( ) { int port = 0 ; try { port = Integer . parseInt ( portText . getText ( ) ) ; } catch ( NumberFormatException e ) { } if ( port <= 0 ) { return "Please specify correct port number" ; } return null ; } public void setValid ( boolean valid ) { detectButton . setEnabled ( valid ) ; } public void lockUI ( boolean lock ) { modeCombo . setEnabled ( ! lock ) ; portText . setEnabled ( ! lock ) ; encodingCombo . setEnabled ( ! lock ) ; timezoneCombo . setEnabled ( ! lock ) ; detectButton . setEnabled ( ! lock ) ; } private void detectTimezone ( ) { if ( ! connectionDialog . isValid ( ) ) { return ; } ConnectionContext context = new ConnectionContext ( ) ; context . setBoolean ( ConnectionContext . DETECT_TIMEZONE , true ) ; if ( connectionDialog . testConnection ( context , null ) ) { String [ ] tzones = ( String [ ] ) context . get ( ConnectionContext . SERVER_TIMEZONE ) ; if ( tzones != null && tzones . length > 0 ) { String tz = timezoneCombo . getItem ( timezoneCombo . getSelectionIndex ( ) ) ; if ( ! Arrays . asList ( tzones ) . contains ( tz ) ) { tz = TimeZoneUtils . getCommonTimeZone ( tzones ) ; int index = timezoneCombo . indexOf ( tz ) ; if ( index >= 0 ) { timezoneCombo . select ( index ) ; } } } } } protected void addListeners ( ) { if ( modifyListener == null ) { modifyListener = new ModifyListener ( ) { public void modifyText ( ModifyEvent e ) { connectionDialog . validate ( ) ; } } ; } portText . addModifyListener ( modifyListener ) ; } protected void removeListeners ( ) { if ( modifyListener != null ) { portText . removeModifyListener ( modifyListener ) ; } } } 