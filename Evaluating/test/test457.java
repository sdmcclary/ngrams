public class ModelBootstrap { private static Context mContext ; private static HashMap < Integer , Form > formIdCache = new HashMap < Integer , Form > ( ) ; private static HashMap < Integer , Vector < Field > > fieldToFormHash = new HashMap < Integer , Vector < Field > > ( ) ; private static HashMap < Integer , SimpleFieldType > fieldTypeHash = new HashMap < Integer , SimpleFieldType > ( ) ; public static void InitApplicationDatabase ( Context context ) { mContext = context ; if ( isFieldTypeTableEmpty ( ) ) { applicationInitialFormFieldTypesBootstrap ( ) ; } MessageTranslator . updateMonitorHash ( context ) ; } private static boolean isFieldTypeTableEmpty ( ) { Uri fieldtypeUri = RapidSmsDBConstants . FieldType . CONTENT_URI ; Cursor fieldtypecheck = mContext . getContentResolver ( ) . query ( fieldtypeUri , null , null , null , null ) ; if ( fieldtypecheck . getCount ( ) == 0 ) { fieldtypecheck . close ( ) ; return true ; } else { fieldtypecheck . close ( ) ; return false ; } } private static String loadAssetFile ( String filename ) { try { InputStream is = mContext . getAssets ( ) . open ( filename ) ; int size = is . available ( ) ; byte [ ] buffer = new byte [ size ] ; is . read ( buffer ) ; is . close ( ) ; String text = new String ( buffer ) ; return text ; } catch ( IOException e ) { throw new RuntimeException ( e ) ; } } private static void applicationInitialFormFieldTypesBootstrap ( ) { loadFieldTypesFromAssets ( ) ; insertFieldTypesIntoDBIfNecessary ( ) ; loadInitialFormsFromAssets ( ) ; checkIfFormTablesExistCreateIfNecessary ( ) ; } private static void insertFieldTypesIntoDBIfNecessary ( ) { Iterator < ? > it = fieldTypeHash . entrySet ( ) . iterator ( ) ; while ( it . hasNext ( ) ) { Map . Entry < Integer , SimpleFieldType > pairs = ( Map . Entry < Integer , SimpleFieldType > ) it . next ( ) ; SimpleFieldType thetype = pairs . getValue ( ) ; Uri fieldtypeUri = Uri . parse ( RapidSmsDBConstants . FieldType . CONTENT_URI_STRING + thetype . getId ( ) ) ; Cursor typeCursor = mContext . getContentResolver ( ) . query ( fieldtypeUri , null , null , null , null ) ; if ( typeCursor . getCount ( ) == 0 ) { ContentValues typecv = new ContentValues ( ) ; typecv . put ( BaseColumns . _ID , thetype . getId ( ) ) ; typecv . put ( RapidSmsDBConstants . FieldType . DATATYPE , thetype . getDataType ( ) ) ; typecv . put ( RapidSmsDBConstants . FieldType . NAME , thetype . getReadableName ( ) ) ; typecv . put ( RapidSmsDBConstants . FieldType . REGEX , thetype . getRegex ( ) ) ; Log . d ( "dimagi" , "InsertFieldType: " + thetype . getId ( ) ) ; Log . d ( "dimagi" , "InsertFieldType: " + thetype . getDataType ( ) ) ; Log . d ( "dimagi" , "InsertFieldType: " + thetype . getReadableName ( ) ) ; Log . d ( "dimagi" , "InsertFieldType: " + thetype . getRegex ( ) ) ; Uri insertedTypeUri = mContext . getContentResolver ( ) . insert ( RapidSmsDBConstants . FieldType . CONTENT_URI , typecv ) ; Log . d ( "dimagi" , "********** Inserted SimpleFieldType into db: " + insertedTypeUri ) ; } typeCursor . close ( ) ; } } private static void loadFieldTypesFromAssets ( ) { String types = loadAssetFile ( "definitions/fieldtypes.json" ) ; try { JSONArray typesarray = new JSONArray ( types ) ; int arrlength = typesarray . length ( ) ; for ( int i = 0 ; i < arrlength ; i ++ ) { try { JSONObject obj = typesarray . getJSONObject ( i ) ; Log . d ( "dimagi" , "type loop: " + i + " model: " + obj . getString ( "model" ) ) ; if ( ! obj . getString ( "model" ) . equals ( "rapidandroid.fieldtype" ) ) { Log . d ( "dimagi" , "###" + obj . getString ( "model" ) + "###" ) ; throw new IllegalArgumentException ( "Error in parsing fieldtypes.json" ) ; } int pk = obj . getInt ( "pk" ) ; JSONObject jsonfields = obj . getJSONObject ( "fields" ) ; Log . d ( "dimagi" , "#### Regex from file: " + jsonfields . getString ( "name" ) + " [" + jsonfields . getString ( "regex" ) + "]" ) ; SimpleFieldType newtype = new SimpleFieldType ( pk , jsonfields . getString ( "datatype" ) , jsonfields . getString ( "regex" ) , jsonfields . getString ( "name" ) ) ; fieldTypeHash . put ( new Integer ( pk ) , newtype ) ; } catch ( JSONException e ) { } } } catch ( JSONException e ) { } } private static void loadInitialFormsFromAssets ( ) { parseFieldsFromAssets ( ) ; parseFormsFromAssets ( ) ; } private static void parseFieldsFromAssets ( ) { String fields = loadAssetFile ( "definitions/fields.json" ) ; try { JSONArray fieldsarray = new JSONArray ( fields ) ; int arrlength = fieldsarray . length ( ) ; for ( int i = 0 ; i < arrlength ; i ++ ) { try { JSONObject obj = fieldsarray . getJSONObject ( i ) ; if ( ! obj . getString ( "model" ) . equals ( "rapidandroid.field" ) ) { } int pk = obj . getInt ( "pk" ) ; JSONObject jsonfields = obj . getJSONObject ( "fields" ) ; int form_id = jsonfields . getInt ( "form" ) ; Field newfield = new Field ( pk , jsonfields . getInt ( "sequence" ) , jsonfields . getString ( "name" ) , jsonfields . getString ( "prompt" ) , fieldTypeHash . get ( new Integer ( jsonfields . getInt ( "fieldtype" ) ) ) ) ; Integer formInt = Integer . valueOf ( form_id ) ; if ( ! fieldToFormHash . containsKey ( formInt ) ) { fieldToFormHash . put ( formInt , new Vector < Field > ( ) ) ; Log . d ( "dimagi" , "### adding a key again?!" + formInt ) ; } fieldToFormHash . get ( formInt ) . add ( newfield ) ; Log . d ( "dimagi" , "#### Parsed field: " + newfield . getFieldId ( ) + " [" + newfield . getName ( ) + "] newlength: " + fieldToFormHash . get ( formInt ) . size ( ) ) ; } catch ( JSONException e ) { Log . d ( "dimagi" , e . getMessage ( ) ) ; } } } catch ( JSONException e ) { } } private static void parseFormsFromAssets ( ) { String forms = loadAssetFile ( "definitions/forms.json" ) ; try { JSONArray formarray = new JSONArray ( forms ) ; int arrlength = formarray . length ( ) ; for ( int i = 0 ; i < arrlength ; i ++ ) { try { JSONObject obj = formarray . getJSONObject ( i ) ; if ( ! obj . getString ( "model" ) . equals ( "rapidandroid.form" ) ) { } int pk = obj . getInt ( "pk" ) ; Integer pkInt = new Integer ( pk ) ; JSONObject jsonfields = obj . getJSONObject ( "fields" ) ; Field [ ] fieldarr = new Field [ fieldToFormHash . get ( pkInt ) . size ( ) ] ; for ( int q = 0 ; q < fieldarr . length ; q ++ ) { fieldarr [ q ] = fieldToFormHash . get ( pkInt ) . get ( q ) ; } Form newform = new Form ( pk , jsonfields . getString ( "formname" ) , jsonfields . getString ( "prefix" ) , jsonfields . getString ( "description" ) , fieldarr , ParserType . SIMPLEREGEX ) ; formIdCache . put ( pkInt , newform ) ; } catch ( JSONException e ) { Log . d ( "dimagi" , e . getMessage ( ) ) ; } } } catch ( JSONException e ) { } } private static void checkIfFormTablesExistCreateIfNecessary ( ) { Iterator < ? > it = formIdCache . entrySet ( ) . iterator ( ) ; while ( it . hasNext ( ) ) { Map . Entry < Integer , Form > pairs = ( Map . Entry < Integer , Form > ) it . next ( ) ; Form f = pairs . getValue ( ) ; Log . d ( "dimagi" , "**** inserting form " + f . getFormName ( ) ) ; Uri formUri = Uri . parse ( RapidSmsDBConstants . Form . CONTENT_URI_STRING + f . getFormId ( ) ) ; Cursor crform = mContext . getContentResolver ( ) . query ( formUri , null , null , null , null ) ; boolean newFormInserted = false ; if ( crform . getCount ( ) == 0 ) { ModelTranslator . addFormToDatabase ( f ) ; } crform . close ( ) ; } } } 