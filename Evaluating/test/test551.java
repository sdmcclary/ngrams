<<<<<<< HEAD
public class PlatformValidatorPatcher { private static final String PREF_BACKUP = "prefBackup" ; public static void start ( ) { final IOperationValidator validator = OperationsManager . getValidator ( ) ; OperationsManager . setValidator ( new OperationValidator ( ) { public IStatus validateCurrentState ( ) { return validator . validateCurrentState ( ) ; } public IStatus validatePendingChanges ( IInstallFeatureOperation [ ] jobs ) { IStatus validatePendingChanges = validator . validatePendingChanges ( jobs ) ; if ( validatePendingChanges == null || validatePendingChanges . getCode ( ) != IStatus . ERROR ) { Exception e = new Exception ( ) ; StackTraceElement [ ] stackTrace = e . getStackTrace ( ) ; boolean isFromUI = false ; for ( int a = 0 ; a < stackTrace . length ; a ++ ) { String className = stackTrace [ a ] . getClassName ( ) ; if ( className . equals ( "org.eclipse.update.internal.ui.wizards.ReviewPage" ) ) { isFromUI = true ; break ; } } if ( ! isFromUI ) { exportPreferences ( ) ; } } return validatePendingChanges ; } public IStatus validatePendingConfig ( IFeature feature ) { return validator . validatePendingConfig ( feature ) ; } public IStatus validatePendingInstall ( IFeature oldFeature , IFeature newFeature ) { return validator . validatePendingInstall ( oldFeature , newFeature ) ; } public IStatus validatePendingReplaceVersion ( IFeature feature , IFeature anotherFeature ) { return validator . validatePendingReplaceVersion ( feature , anotherFeature ) ; } public IStatus validatePendingRevert ( IInstallConfiguration config ) { return validator . validatePendingRevert ( config ) ; } public IStatus validatePendingUnconfig ( IFeature feature ) { return validator . validatePendingUnconfig ( feature ) ; } public IStatus validatePlatformConfigValid ( ) { return validator . validatePlatformConfigValid ( ) ; } } ) ; } private static void exportPreferences ( ) { IPreferenceStore preferenceStore = CoreUIPlugin . getDefault ( ) . getPreferenceStore ( ) ; if ( preferenceStore . getBoolean ( IPreferenceConstants . PREF_AUTO_BACKUP_ENABLED ) ) { String string = preferenceStore . getString ( IPreferenceConstants . PREF_AUTO_BACKUP_PATH ) ; File folder = new File ( string ) ; folder . mkdirs ( ) ; doExport ( folder ) ; } } private static void doExport ( File folder ) { long currentTimeMillis = System . currentTimeMillis ( ) ; Date dt = new Date ( currentTimeMillis ) ; DateFormat dateInstance = DateFormat . getDateInstance ( DateFormat . SHORT ) ; String fDate = dateInstance . format ( dt ) ; fDate = StringUtils . replace ( fDate , "/" , "_" ) ; fDate = StringUtils . replace ( fDate , "\\" , "_" ) ; String fName = FileUtils . ensureValidFilename ( PREF_BACKUP + fDate + ".epr" ) ; File fl = new File ( folder , fName ) ; int a = 1 ; while ( fl . exists ( ) ) { fName = FileUtils . ensureValidFilename ( PREF_BACKUP + fDate + "v" + a + ".epr" ) ; a ++ ; fl = new File ( folder , fName ) ; } exportPreferences ( fl ) ; IPreferenceStore preferenceStore = CoreUIPlugin . getDefault ( ) . getPreferenceStore ( ) ; preferenceStore . putValue ( IPreferenceConstants . PREF_AUTO_BACKUP_LASTNAME , fl . getAbsolutePath ( ) ) ; } public static boolean exportPreferences ( File file ) { IPreferencesService service = Platform . getPreferencesService ( ) ; try { FileOutputStream transfers = new FileOutputStream ( file ) ; String [ ] fos = new String [ 0 ] ; service . exportPreferences ( service . getRootNode ( ) , transfers , fos ) ; transfers . flush ( ) ; transfers . close ( ) ; return true ; } catch ( final IOException e ) { IdeLog . logError ( CoreUIPlugin . getDefault ( ) , Messages . getString ( "PlatformValidatorPatcher.ERR_ErrorExportingPreferences" ) , e ) ; UIJob job = new UIJob ( "Export Preferences" ) { public IStatus runInUIThread ( IProgressMonitor monitor ) { MessageDialog . openError ( getDisplay ( ) . getActiveShell ( ) , new String ( ) , e . getLocalizedMessage ( ) ) ; return Status . OK_STATUS ; } } ; job . setSystem ( true ) ; job . schedule ( ) ; return false ; } catch ( final CoreException e ) { IdeLog . logError ( CoreUIPlugin . getDefault ( ) , Messages . getString ( "PlatformValidatorPatcher.ERR_ErrorExportingPreferences" ) , e ) ; UIJob job = new UIJob ( "Export Preferences" ) { public IStatus runInUIThread ( IProgressMonitor monitor ) { MessageDialog . openError ( getDisplay ( ) . getActiveShell ( ) , new String ( ) , e . getLocalizedMessage ( ) ) ; return Status . OK_STATUS ; } } ; job . setSystem ( true ) ; job . schedule ( ) ; return false ; } } public static boolean importPreferences ( File file ) { IPreferencesService service = Platform . getPreferencesService ( ) ; try { IStatus importPreferences = service . importPreferences ( new FileInputStream ( file ) ) ; return importPreferences . getCode ( ) == IStatus . OK ; } catch ( final CoreException e ) { IdeLog . logError ( CoreUIPlugin . getDefault ( ) , Messages . getString ( "PlatformValidatorPatcher.ERR_ErrorImportingPreferences" ) , e ) ; UIJob job = new UIJob ( "Import Preferences" ) { public IStatus runInUIThread ( IProgressMonitor monitor ) { MessageDialog . openError ( getDisplay ( ) . getActiveShell ( ) , new String ( ) , e . getLocalizedMessage ( ) ) ; return Status . OK_STATUS ; } } ; job . setSystem ( true ) ; job . schedule ( ) ; return false ; } catch ( final FileNotFoundException e ) { IdeLog . logError ( CoreUIPlugin . getDefault ( ) , Messages . getString ( "PlatformValidatorPatcher.ERR_ErrorImportingPreferences" ) , e ) ; UIJob job = new UIJob ( "Import Preferences" ) { public IStatus runInUIThread ( IProgressMonitor monitor ) { MessageDialog . openError ( getDisplay ( ) . getActiveShell ( ) , new String ( ) , e . getLocalizedMessage ( ) ) ; return Status . OK_STATUS ; } } ; job . setSystem ( true ) ; job . schedule ( ) ; return false ; } } } 
=======
public class MimeType extends AbstractDatatype { public static final MimeType THE_INSTANCE = new MimeType ( ) ; private enum State { AT_START , IN_SUPERTYPE , AT_SUBTYPE_START , IN_SUBTYPE , SEMICOLON_SEEN , WS_BEFORE_SEMICOLON , IN_PARAM_NAME , EQUALS_SEEN , IN_QUOTED_STRING , IN_UNQUOTED_STRING , IN_QUOTED_PAIR , CLOSE_QUOTE_SEEN } private MimeType ( ) { super ( ) ; } @ Override public void checkValid ( CharSequence literal ) throws DatatypeException { State state = State . AT_START ; for ( int i = 0 ; i < literal . length ( ) ; i ++ ) { char c = literal . charAt ( i ) ; switch ( state ) { case AT_START : if ( isTokenChar ( c ) ) { state = State . IN_SUPERTYPE ; continue ; } else { throw newDatatypeException ( i , "Expected a token character but saw " , c , " instead." ) ; } case IN_SUPERTYPE : if ( isTokenChar ( c ) ) { continue ; } else if ( c == '/' ) { state = State . AT_SUBTYPE_START ; continue ; } else { throw newDatatypeException ( i , "Expected a token character or “/” but saw " , c , " instead." ) ; } case AT_SUBTYPE_START : if ( isTokenChar ( c ) ) { state = State . IN_SUBTYPE ; continue ; } else { throw newDatatypeException ( i , "Expected a token character but saw " , c , " instead." ) ; } case IN_SUBTYPE : if ( isTokenChar ( c ) ) { continue ; } else if ( c == ';' ) { state = State . SEMICOLON_SEEN ; continue ; } else if ( isWhitespace ( c ) ) { state = State . WS_BEFORE_SEMICOLON ; continue ; } else { throw newDatatypeException ( i , "Expected a token character, whitespace or a semicolon but saw " , c , " instead." ) ; } case WS_BEFORE_SEMICOLON : if ( isWhitespace ( c ) ) { continue ; } else if ( c == ';' ) { state = State . SEMICOLON_SEEN ; continue ; } else { throw newDatatypeException ( i , "Expected whitespace or a semicolon but saw " , c , " instead." ) ; } case SEMICOLON_SEEN : if ( isWhitespace ( c ) ) { continue ; } else if ( isTokenChar ( c ) ) { state = State . IN_PARAM_NAME ; continue ; } else { throw newDatatypeException ( i , "Expected whitespace or a token character but saw " , c , " instead." ) ; } case IN_PARAM_NAME : if ( isTokenChar ( c ) ) { continue ; } else if ( c == '=' ) { state = State . EQUALS_SEEN ; continue ; } case EQUALS_SEEN : if ( c == '\"' ) { state = State . IN_QUOTED_STRING ; continue ; } else if ( isTokenChar ( c ) ) { state = State . IN_UNQUOTED_STRING ; continue ; } else { throw newDatatypeException ( i , "Expected a double quote or a token character but saw " , c , " instead." ) ; } case IN_QUOTED_STRING : if ( c == '\\' ) { state = State . IN_QUOTED_PAIR ; continue ; } else if ( c == '\"' ) { state = State . CLOSE_QUOTE_SEEN ; continue ; } else if ( isQDTextChar ( c ) ) { continue ; } else { throw newDatatypeException ( i , "Expected a non-control ASCII character but saw " , c , " instead." ) ; } case IN_QUOTED_PAIR : if ( c <= 127 ) { state = State . IN_QUOTED_STRING ; continue ; } else { throw newDatatypeException ( i , "Expected an ASCII character but saw " , c , " instead." ) ; } case CLOSE_QUOTE_SEEN : if ( c == ';' ) { state = State . SEMICOLON_SEEN ; continue ; } else if ( isWhitespace ( c ) ) { state = State . WS_BEFORE_SEMICOLON ; continue ; } else { throw newDatatypeException ( i , "Expected an ASCII character but saw " , c , " instead." ) ; } case IN_UNQUOTED_STRING : if ( isTokenChar ( c ) ) { continue ; } else if ( c == ';' ) { state = State . SEMICOLON_SEEN ; continue ; } else if ( isWhitespace ( c ) ) { state = State . WS_BEFORE_SEMICOLON ; continue ; } else { throw newDatatypeException ( i , "Expected a token character, whitespace or a semicolon but saw " , c , " instead." ) ; } } } switch ( state ) { case IN_SUBTYPE : case IN_UNQUOTED_STRING : case CLOSE_QUOTE_SEEN : return ; case AT_START : throw newDatatypeException ( "Expected a MIME type but saw the empty string." ) ; case IN_SUPERTYPE : case AT_SUBTYPE_START : throw newDatatypeException ( literal . length ( ) - 1 , "Subtype missing." ) ; case EQUALS_SEEN : case IN_PARAM_NAME : throw newDatatypeException ( literal . length ( ) - 1 , "Parameter value missing." ) ; case IN_QUOTED_PAIR : case IN_QUOTED_STRING : throw newDatatypeException ( literal . length ( ) - 1 , "Unfinished quoted string." ) ; case SEMICOLON_SEEN : throw newDatatypeException ( literal . length ( ) - 1 , "Semicolon seen but there was no parameter following it." ) ; case WS_BEFORE_SEMICOLON : throw newDatatypeException ( literal . length ( ) - 1 , "Extraneous trailing whitespace." ) ; } } private boolean isQDTextChar ( char c ) { return ( c >= ' ' && c <= 126 ) || ( c == '\n' ) || ( c == '\r' ) || ( c == '\t' ) ; } private boolean isTokenChar ( char c ) { return ( c >= 33 && c <= 126 ) && ! ( c == '(' || c == ')' || c == '<' || c == '>' || c == '@' || c == ',' || c == ';' || c == ':' || c == '\\' || c == '\"' || c == '/' || c == '[' || c == ']' || c == '?' || c == '=' || c == '{' || c == '}' ) ; } @ Override public String getName ( ) { return "MIME type" ; } } 
>>>>>>> ab1fba6c6e93a4331abe98d3c4c0cdc860e899a6
